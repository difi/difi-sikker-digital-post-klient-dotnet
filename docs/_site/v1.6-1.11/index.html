<!DOCTYPE html>
<html lang="no">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="shortcut icon" href="//www.difi.no/profiles/difino/themes/difi3_difino/favicon.ico" type="image/vnd.microsoft.icon" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link type="text/css" rel="stylesheet" href="//www.difi.no/_style/site/difino/style.css" media="screen" />
	<link href="/sikker-digital-post-klient-dotnet/assets/css/docs.min.css" rel="stylesheet">
	<link href="/sikker-digital-post-klient-dotnet/assets/css/style.css" rel="stylesheet">
	<link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800%7COpen+Sans+Condensed:300,700%7CSource+Sans+Pro:200,300,regular,600,700,900&amp;subset=latin-ext,vietnamese,latin" media="all" />
	
	<!--[if lt IE 9]>
	<script type="text/javascript" src="//www.difi.no/_style/lib/html5shiv/html5shiv-3.7.2.min.js"></script>
	<script type="text/javascript" src="//www.difi.no/_style/lib/respond/respond-1.4.2.min.js"></script>
	<![endif]-->
	<body class="nodetype-blogg content-article aside-right" >
		<a id="top"/>
			<div id="skip-link">
				<a href="#content">Hopp til hovedinnhold</a>
			</div>
			<div id="page">
				<header>
					<div class="branding sub-portal">
						<div class="logo">
							<a href="/sikker-digital-post-klient-dotnet/"><span>difi.github.io/difi-sikker-digital-post-klient-dotnet</span></a>
						</div>
						<div class="seperator"></div>
						<div class="sub-portal">
							<h1>Sikker Digital Post .NET</h1>
							<p>difi.github.io/difi-sikker-digital-post-klient-dotnet</p>
						</div>
					</div>
					<div class="tools">
						<div class="menu">
							<h2>Sekundærmeny</h2>
							<ul class="links">
								
									<li  class="first" ><a href="/sikker-digital-post-klient-dotnet/about.html">Om sikker digital post</a></li>
								
									<li ><a href="https://github.com/difi/sikker-digital-post-net-klient">GitHub</a></li>
								
									<li  class="last" ><a href="https://github.com/difi/sikker-digital-post-net-klient/issues">Issues</a></li>
								
							</ul>
						</div>
					</div>
					
				</header>
				<div id="above-content">
					<div>
						<section class="box title">
							<div class="heading">
							</div>
							<div class="body">
								<h1>
								<span style="opacity: 1; transition: opacity 500ms; -webkit-transition: opacity 500ms;">
									.NET-bibliotek for sending av sikker digital post for offentlig sektor
								</span>
								</h1>
							</div>
						</section>
						<div class="col-md-9" role="main">
							<!-- Info box notifying that you are using old documentation -->
							
								<div class="alert alert-info">
									Du ser nå på dokumentasjonen for Sikker-digital-post-klient-dotnet 1.6-1.11, som ikke er den nyeste versjonen av klienten. Den nyeste versjonen er 3 og kan nåes <a href="/sikker-digital-post-klient-dotnet/">her</a>.
								</div>
							
						</div>
					</div>
				</div>
				
					<div id="main" class="with-aside">
						<section id="content" tabindex="-1">
							<article class="one-col">
								
									<div class="body">
										<div class="button custom" data-button-type="0" data-url="https://www.nuget.org/packages?q=Difi.SikkerDigitalPost.Klient" role="button" tabindex="0">
											<div class="logo">
												<img alt="logo" src="//www.difi.no/modules/contrib/difi_ckeditor_widgets/plugins/difibutton/icons/difibutton.png">
											</div>
											<div class="text">
												<div class="title">Last ned</div>
												<div class="sub-title">Gå til https://www.nuget.org/packages?q=Difi.SikkerDigitalPost.Klient</div>
											</div>
											<div class="arrow">›</div>
										</div>
									</div>
								
								
	
		<h2 id="hvordankommeigang">Hvordan komme i gang</h2>
		<div class="body">
			<p><p>Klienten er tilgjengelig som en NuGet-pakke. Denne vil oppdateres jevnlig etter hvert som ny funksjonalitet legges til.</p>

<p>For å installere NuGet-pakken, gjør følgende:</p>

<ol>
  <li>Velg <em>TOOLS -&gt; NuGet Package Manager -&gt; Manage Nuget Packages for Solution…</em></li>
  <li>Søk etter <em>sikker-digital-post</em>.
    <ul>
      <li>Ønsker du pre-release, må du sørge for at det står <em>Include Prerelease</em> i drop-down menyen rett over søkeresuløtatene (der det står <em>Stable Only</em>).</li>
    </ul>
  </li>
  <li>Velg <em>sikker-digital-post-klient</em> og trykk <em>Install</em>.</li>
</ol>
</p>
		</div>
	

	
		<h2 id="sendepost">Sende post</h2>
		<div class="body">
			<p><blockquote>
  <p>Det anbefales å bruke dokumentasjon i klassene for mer detaljert beskrivelse av inputparametere.</p>
</blockquote>

<h3 id="postinfo-for-digital-post">PostInfo for digital post</h3>

<p>Først, lag en motaker av type <code class="highlighter-rouge">DigitalPostMottaker</code>:</p>

<blockquote>
  <p>Postkassetjenesteleverandørene har ulik behandling av ikke-sensitiv tittel. Se <a href="http://begrep.difi.no/Felles/ikkeSensitivTittel">begrep.difi.no</a> for detaljer om denne forskjellen.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">personnummer</span> <span class="p">=</span> <span class="s">"01013300002"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">postkasseadresse</span> <span class="p">=</span> <span class="s">"ola.nordmann#2233"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">mottakersertifikat</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509Certificate2</span><span class="p">();</span> <span class="c1">//sertifikat hentet fra Oppslagstjenesten
</span><span class="kt">var</span> <span class="n">orgnummerPostkasse</span> <span class="p">=</span> <span class="s">"123456789"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">mottaker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DigitalPostMottaker</span><span class="p">(</span>
	    <span class="n">personnummer</span><span class="p">,</span> 
	    <span class="n">postkasseadresse</span><span class="p">,</span> 
	    <span class="n">mottakersertifikat</span><span class="p">,</span> 
	    <span class="n">orgnummerPostkasse</span>
    <span class="p">);</span>

<span class="kt">var</span> <span class="n">ikkeSensitivTittel</span> <span class="p">=</span> <span class="s">"En tittel som ikke er sensitiv"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">sikkerhetsniv</span><span class="err">å</span> <span class="p">=</span> <span class="n">Sikkerhetsniv</span><span class="err">å</span><span class="p">.</span><span class="n">Niv</span><span class="err">å</span><span class="m">3</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">postInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DigitalPostInfo</span><span class="p">(</span><span class="n">mottaker</span><span class="p">,</span> <span class="n">ikkeSensitivTittel</span><span class="p">,</span> <span class="n">sikkerhetsniv</span><span class="err">å</span><span class="p">);</span></code></pre></figure>

<blockquote>
  <p>Husk at <code class="highlighter-rouge">OrgnummerPostkasse</code> er organisasjonsnummer til leverandør av postkassetjenesten. Organisasjonsnummeret leveres fra oppslagstjenesten sammen med postkasseadressen og sertifikatet til innbygger.</p>
</blockquote>

<h3 id="postinfo-for-fysisk-post">PostInfo for fysisk post</h3>

<p>Skal du sende fysisk post må du først lage en <code class="highlighter-rouge">FysiskPostMottaker</code>, en <code class="highlighter-rouge">FysiskPostReturMottaker</code> og sette informasjon om farge og makulering:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">navn</span> <span class="p">=</span> <span class="s">"Ola Nordmann"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">adresse</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NorskAdresse</span><span class="p">(</span><span class="s">"0001"</span><span class="p">,</span> <span class="s">"Oslo"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">mottakersertifikat</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509Certificate2</span><span class="p">();</span> <span class="c1">// sertifikat hentet fra Oppslagstjenesten
</span><span class="kt">var</span> <span class="n">orgnummerPostkasse</span> <span class="p">=</span> <span class="s">"123456789"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">mottaker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FysiskPostMottaker</span><span class="p">(</span><span class="n">navn</span><span class="p">,</span> <span class="n">adresse</span><span class="p">,</span> <span class="n">mottakersertifikat</span><span class="p">,</span> <span class="n">orgnummerPostkasse</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">returMottaker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FysiskPostReturmottaker</span><span class="p">(</span>
    <span class="s">"John Doe"</span><span class="p">,</span> 
    <span class="k">new</span> <span class="nf">NorskAdresse</span><span class="p">(</span><span class="s">"0566"</span><span class="p">,</span> <span class="s">"Oslo"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Adresselinje1</span> <span class="p">=</span> <span class="s">"Returgata 22"</span>
    <span class="p">});</span>

<span class="kt">var</span> <span class="n">postInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FysiskPostInfo</span><span class="p">(</span>
            <span class="n">mottaker</span><span class="p">,</span> 
            <span class="n">Posttype</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> 
            <span class="n">Utskriftsfarge</span><span class="p">.</span><span class="n">SortHvitt</span><span class="p">,</span> 
            <span class="n">Posth</span><span class="err">å</span><span class="n">ndtering</span><span class="p">.</span><span class="n">MakuleringMedMelding</span><span class="p">,</span> 
            <span class="n">returMottaker</span>
        <span class="p">);</span></code></pre></figure>

<p>Her er adressen av type <code class="highlighter-rouge">NorskAdresse</code> eller <code class="highlighter-rouge">UtenlandskAdresse</code>.</p>

<p>Ved sending av fysisk post må man oppgi en returadresse, uavhengig av om brevet er satt til <code class="highlighter-rouge">Posthåndtering.MakuleringMedMelding</code>. Oppretting av en FysiskPostInfo vil da se slik ut:</p>

<h3 id="oppsett-før-sending">Oppsett før sending</h3>

<p>Opprett en avsender og en databehandler:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">orgnummerAvsender</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Organisasjonsnummer</span><span class="p">(</span><span class="s">"123456789"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">avsender</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Avsender</span><span class="p">(</span><span class="n">orgnummerAvsender</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">orgnummerDatabehandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Organisasjonsnummer</span><span class="p">(</span><span class="s">"987654321"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">avsendersertifikat</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509Certificate2</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">databehandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Databehandler</span><span class="p">(</span><span class="n">orgnummerDatabehandler</span><span class="p">,</span> <span class="n">avsendersertifikat</span><span class="p">);</span></code></pre></figure>

<p>Hvis man har flere avdelinger innenfor samme organisasjonsnummer, har disse fått unike avsenderidentifikatorer, og kan settes på følgende måte:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">avsender</span><span class="p">.</span><span class="n">Avsenderidentifikator</span> <span class="p">=</span> <span class="s">"Avsenderidentifikator I Organisasjon"</span><span class="p">;</span></code></pre></figure>

<h3 id="opprette-forsendelse">Opprette forsendelse</h3>

<p>Deretterer kan du opprette forsendelse. Forsendelsen inneholder de dokumentene
 som skal til mottakeren:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">hoveddokument</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Dokument</span><span class="p">(</span>
        <span class="n">tittel</span><span class="p">:</span> <span class="s">"Dokumenttittel"</span><span class="p">,</span> 
        <span class="n">dokumentsti</span><span class="p">:</span> <span class="s">"/Dokumenter/Hoveddokument.pdf"</span><span class="p">,</span> 
        <span class="n">mimeType</span><span class="p">:</span> <span class="s">"application/pdf"</span><span class="p">,</span> 
        <span class="n">spr</span><span class="err">å</span><span class="n">kkode</span><span class="p">:</span> <span class="s">"NO"</span><span class="p">,</span> 
        <span class="n">filnavn</span><span class="p">:</span> <span class="s">"filnavn"</span>
    <span class="p">);</span>

<span class="kt">var</span> <span class="n">dokumentpakke</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Dokumentpakke</span><span class="p">(</span><span class="n">hoveddokument</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">vedleggssti</span> <span class="p">=</span> <span class="s">"/Dokumenter/Vedlegg.pdf"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">vedlegg</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Dokument</span><span class="p">(</span>
    <span class="n">tittel</span><span class="p">:</span> <span class="s">"tittel"</span><span class="p">,</span> 
    <span class="n">dokumentsti</span><span class="p">:</span> <span class="n">vedleggssti</span><span class="p">,</span> 
    <span class="n">mimeType</span><span class="p">:</span> <span class="s">"application/pdf"</span><span class="p">,</span> 
    <span class="n">spr</span><span class="err">å</span><span class="n">kkode</span><span class="p">:</span> <span class="s">"NO"</span><span class="p">,</span> 
    <span class="n">filnavn</span><span class="p">:</span> <span class="s">"filnavn"</span><span class="p">);</span>

<span class="n">dokumentpakke</span><span class="p">.</span><span class="nf">LeggTilVedlegg</span><span class="p">(</span><span class="n">vedlegg</span><span class="p">);</span>

<span class="n">Avsender</span> <span class="n">avsender</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span> <span class="c1">//Som initiert tidligere
</span><span class="n">PostInfo</span> <span class="n">postInfo</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span> <span class="c1">//Som initiert tidligere
</span><span class="kt">var</span> <span class="n">forsendelse</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Forsendelse</span><span class="p">(</span><span class="n">avsender</span><span class="p">,</span> <span class="n">postInfo</span><span class="p">,</span> <span class="n">dokumentpakke</span><span class="p">);</span></code></pre></figure>

<h3 id="opprette-klient-og-sende-post">Opprette klient og sende post</h3>

<p>Siste steg er å opprette en <code class="highlighter-rouge">SikkerDigitalPostKlient</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">klientKonfig</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Klientkonfigurasjon</span><span class="p">(</span><span class="n">Milj</span><span class="err">ø</span><span class="p">.</span><span class="n">FunksjoneltTestmilj</span><span class="err">ø</span><span class="p">);</span>

<span class="n">Databehandler</span> <span class="n">databehandler</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span> <span class="c1">//Som initiert tidligere
</span><span class="n">Forsendelse</span> <span class="n">forsendelse</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>     <span class="c1">//Som initiert tidligere
</span>
<span class="kt">var</span> <span class="n">sdpKlient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SikkerDigitalPostKlient</span><span class="p">(</span><span class="n">databehandler</span><span class="p">,</span> <span class="n">klientKonfig</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">transportkvittering</span> <span class="p">=</span> <span class="n">sdpKlient</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">forsendelse</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">transportkvittering</span> <span class="k">is</span> <span class="n">TransportOkKvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//Når alt går fint	
</span><span class="p">}</span>
<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">transportkvittering</span> <span class="k">is</span> <span class="n">TransportFeiletKvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">beskrivelse</span> <span class="p">=</span> <span class="p">((</span><span class="n">TransportFeiletKvittering</span><span class="p">)</span><span class="n">transportkvittering</span><span class="p">).</span><span class="n">Beskrivelse</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Transportkvitteringen får du tilbake umiddelbart; den trenger du ikke å polle for å få.</p>

<h3 id="hente-kvitteringer">Hente kvitteringer</h3>

<p>For å hente kvitteringer må du sende en kvitteringsforespørsel:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">k</span><span class="err">ø</span><span class="n">Id</span> <span class="p">=</span> <span class="s">"MpcId"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">kvitteringsForesp</span><span class="err">ø</span><span class="n">rsel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Kvitteringsforesp</span><span class="err">ø</span><span class="nf">rsel</span><span class="p">(</span><span class="n">Prioritet</span><span class="p">.</span><span class="n">Prioritert</span><span class="p">,</span> <span class="n">k</span><span class="err">ø</span><span class="n">Id</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">" &gt; Henter kvittering på kø '{0}'..."</span><span class="p">,</span> <span class="n">kvitteringsForesp</span><span class="err">ø</span><span class="n">rsel</span><span class="p">.</span><span class="n">Mpc</span><span class="p">);</span>

<span class="n">Kvittering</span> <span class="n">kvittering</span> <span class="p">=</span> <span class="n">sdpKlient</span><span class="p">.</span><span class="nf">HentKvittering</span><span class="p">(</span><span class="n">kvitteringsForesp</span><span class="err">ø</span><span class="n">rsel</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">TomK</span><span class="err">ø</span><span class="n">Kvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - Kø '{0}' er tom. Stopper å hente meldinger. "</span><span class="p">,</span> <span class="n">kvitteringsForesp</span><span class="err">ø</span><span class="n">rsel</span><span class="p">.</span><span class="n">Mpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">TransportFeiletKvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">feil</span> <span class="p">=</span> <span class="p">((</span><span class="n">TransportFeiletKvittering</span><span class="p">)</span> <span class="n">kvittering</span><span class="p">).</span><span class="n">Beskrivelse</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"En feil skjedde under transport."</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">Leveringskvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - En leveringskvittering ble hentet!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="err">Å</span><span class="n">pningskvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - Har du sett. Noen har åpnet et brev. Moro."</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">Returpostkvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - Du har fått en returpostkvittering for fysisk post."</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">Mottakskvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - Kvittering på sending av fysisk post mottatt."</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">Feilmelding</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">feil</span> <span class="p">=</span> <span class="p">(</span><span class="n">Feilmelding</span><span class="p">)</span><span class="n">kvittering</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - En feilmelding ble hentet :"</span> <span class="p">+</span> <span class="n">feil</span><span class="p">.</span><span class="n">Detaljer</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<blockquote>
  <p>Husk at det ikke er mulig å hente nye kvitteringer før du har bekreftet mottak av nåværende.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">sdpKlient</span><span class="p">.</span><span class="nf">Bekreft</span><span class="p">((</span><span class="n">Forretningskvittering</span><span class="p">)</span><span class="n">kvittering</span><span class="p">);</span></code></pre></figure>

<p>Kvitteringer du mottar når du gjør en kvitteringsforespørsel kan være av følgende typer: <code class="highlighter-rouge">Leveringskvittering</code>,<code class="highlighter-rouge">Åpningskvittering</code>, <code class="highlighter-rouge">Returpostkvittering</code>, <code class="highlighter-rouge">Mottakskvittering</code> eller <code class="highlighter-rouge">Feilmelding</code>. Kvittering kan også være av typen<code class="highlighter-rouge">TransportFeiletKvittering</code>. Dette kan skje når selve kvitteringsforespørselen er feilformatert.</p>

<blockquote>
  <p>Husk at hvis du får <code class="highlighter-rouge">TomKøKvittering</code> så er køen tom. Du henter bare kvitteringer fra kø gitt av <code class="highlighter-rouge">MpcId</code> og <code class="highlighter-rouge">Prioritet</code>. Hvis ikke dette blir satt spesifikt vil det hentes fra kø hvor <code class="highlighter-rouge">MpcId = ""</code> og <code class="highlighter-rouge">Prioritet = Prioritet.Normal</code>.</p>
</blockquote>

</p>
		</div>
	

	
		<h2 id="logging">Logging</h2>
		<div class="body">
			<p><h3 id="generelt">Generelt</h3>

<p>Klienten bruker <em>Common.Logging API</em> for å abstrahere logging. Det er opp til brukeren å imlementere API med et passende loggrammeverk, men vi viser hvordan dette kan gjøres med Log4Net.</p>

<p>Loggnivå <code class="highlighter-rouge">DEBUG</code> vil logge resultat for forespørsler som går bra og de  som feiler, <code class="highlighter-rouge">WARN</code> bare for feilede forespørsler eller verre, mens <code class="highlighter-rouge">ERROR</code>  bare skjer om sending av brev feilet. Disse loggerne vil være under <code class="highlighter-rouge">Difi.SikkerDigitalPost.Klient</code></p>

<h3 id="implementere-log4net-som-logger">Implementere Log4Net som logger</h3>

<ol>
  <li>Installer Nuget-pakke <code class="highlighter-rouge">Common.Logging.Log4Net</code>. Denne vil da også installere avhengighetene <code class="highlighter-rouge">Common.Logging.Core</code> og <code class="highlighter-rouge">Common.Logging</code>. Merk at versjoneringen her er litt underlig, men et søk i Nuget Gallery vil f.eks. vise at Log4Net 2.0.3 har pakkenavn <em>Log4net [1.2.13] 2.0.3</em>. Da er det <code class="highlighter-rouge">Common.Logging.Log4Net1213</code> som skal installeres.</li>
  <li>Legg merke til hvilken versjon av Log4net som faktisk installeres. Av en eller annen grunn kan det bli 2.0.0 som installeres. Da må versjonen oppdateres til 2.0.3.</li>
</ol>

<p>En fullstendig App.config med Log4Net-adapter og en <code class="highlighter-rouge">RollingFileAppender</code>:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;configSections&gt;</span>
    <span class="nt">&lt;sectionGroup</span> <span class="na">name=</span><span class="s">"common"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">"logging"</span> <span class="na">type=</span><span class="s">"Common.Logging.ConfigurationSectionHandler, Common.Logging"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sectionGroup&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">"log4net"</span> <span class="na">type=</span><span class="s">"log4net.Config.Log4NetConfigurationSectionHandler, log4net"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/configSections&gt;</span>

  <span class="nt">&lt;common&gt;</span>
    <span class="nt">&lt;logging&gt;</span>
      <span class="nt">&lt;factoryAdapter</span> <span class="na">type=</span><span class="s">"Common.Logging.Log4Net.Log4NetLoggerFactoryAdapter, Common.Logging.Log4net1213"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;arg</span> <span class="na">key=</span><span class="s">"configType"</span> <span class="na">value=</span><span class="s">"INLINE"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/factoryAdapter&gt;</span>
    <span class="nt">&lt;/logging&gt;</span>
  <span class="nt">&lt;/common&gt;</span>

   <span class="nt">&lt;log4net&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"RollingFileAppender"</span> <span class="na">type=</span><span class="s">"log4net.Appender.RollingFileAppender"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;lockingModel</span> <span class="na">type=</span><span class="s">"log4net.Appender.FileAppender+MinimalLock"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;file</span> <span class="na">value=</span><span class="s">"${AppData}\Digipost\SikkerDigitalPost\"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;appendToFile</span> <span class="na">value=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;rollingStyle</span> <span class="na">value=</span><span class="s">"Date"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;staticLogFileName</span> <span class="na">value=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;rollingStyle</span> <span class="na">value=</span><span class="s">"Composite"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"maxSizeRollBackups"</span> <span class="na">value=</span><span class="s">"10"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;datePattern</span> <span class="na">value=</span><span class="s">"yyyy.MM.dd' sikker-digital-post-klient-dotnet.log'"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;maximumFileSize</span> <span class="na">value=</span><span class="s">"100MB"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;layout</span> <span class="na">type=</span><span class="s">"log4net.Layout.PatternLayout"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;conversionPattern</span> <span class="na">value=</span><span class="s">"%date [%thread] %-5level %logger - %message%newline"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/layout&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
   <span class="nt">&lt;root&gt;</span>
      <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"RollingFileAppender"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/root&gt;</span>
  <span class="nt">&lt;/log4net&gt;</span>
<span class="nt">&lt;/configuration&gt;</span></code></pre></figure>

<h3 id="loggeforsporselogrespons"> Logge forespørsel og respons</h3>

<p>Når det sendes brev gjennom Sikker Digital Post, så legges det også ved en del ekstra informasjon. Denne informasjonen er strukturert som XML og er nødvending for at brevet skal leveres til mottaker. Ofte kan dette være svært nyttig informasjon å logge.</p>

<p>For å aktivere logging av forespørsel og respons så setter du følgende på <code>Klientkonfigurasjon</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Klientkonfigurasjon</span><span class="p">.</span><span class="n">LoggForesp</span><span class="err">ø</span><span class="n">rselOgRespons</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span></code></pre></figure>

<p>Da  vil det logges til en logger med navn <code class="highlighter-rouge">Difi.SikkerDigitalPost.Klient.RequestResponse</code>.</p>

<blockquote> Merk at logging av forespørsel og respons kan gi mye dårligere ytelse. Det er ingen grunn til å logge dette i et produksjonsmiljø.</blockquote>

<h3 id="dokumentpakkelogger">Prosessere dokumentpakke som sendes</h3>

<p>Når man logger forespørsel og respons, så logges  bare XML som sendes, ikke selve dokumentpakken. Det er to måter å logge denne på:</p>
<ol>
  <li>Aktiver logging til disk vha <code>Klientkonfigurasjon.AktiverLagringAvDokumentpakkeTilDisk</code>.</li>
  <li>Implementer <code>IDokumentPakkeProsessor</code> og legg til i <code>Klientkonfigurasjon.Dokumentpakkeprosessorer</code></li>
</ol>
</p>
		</div>
	

	
		<h2 id="installeresertifikater">Installere sertifikater</h2>
		<div class="body">
			<p><p>Som bruker av dette biblioteket er du en Databehandler som har ansvar for sending av meldinger. For å gjøre dette trenger du et sertifikat for å kunne autentisere deg mot Meldingsformidleren. Du kan lese mer om aktørene hos <a href="http://begrep.difi.no/SikkerDigitalPost/forretningslag/Aktorer">begrep.difi.no</a>. Dette bør installeres på maskinen som skal bruke klientbiblioteket. Grunnen til at vi ønsker å installere det er for å ikke ha passord i klartekst i koden.</p>

<p>Alle sertifikater har en unik identifikator som kalles thumbprint. Hvis du ikke ønsker å håndtere selv i koden hvordan sertifikatene skal lastes, så kan du følge guiden under, steg for steg. Til slutt gjennomgås det hvordan du kan finne thumbprint til det installerte sertifikatet.</p>

<h3 id="legg-inn-databehandlersertifikat-i-certificate-store">Legg inn databehandlersertifikat i certificate store</h3>

<blockquote>
  <p>Databehandlersertifikat er det sertifikatet du har fått utstedt for å kunne sende post.</p>
</blockquote>

<ol>
  <li>Dobbeltklikk på sertifikatet (Sertifikatnavn.p12)</li>
  <li>Velg at sertifikatet skal lagres i <em>Current User</em> eller <em>Local Machine</em> og trykk <em>Next</em></li>
  <li>Filnavn skal nå være utfylt. Trykk <em>Next</em></li>
  <li>Skriv inn passord for privatnøkkel og velg <em>Mark this key as exportable …</em>, trykk <em>Next</em></li>
  <li>Velg <em>Automatically select the certificate store based on the type of certificate</em></li>
  <li>Klikk <em>Next</em> og <em>Finish</em></li>
  <li>Får du spørsmål om å godta sertifikatkjeden så du gjør det.</li>
  <li>Du skal da få en dialog som sier at importeringen var vellykket. Trykk <em>OK</em>.</li>
</ol>

<h3 id="finne-thumbprint-til-installert-sertifikat">Finne thumbprint til installert sertifikat</h3>

<p>Det er enklest å finne thumbprint gjennom <em>Microsoft Management Console</em> (mmc.exe).</p>

<ol>
  <li>Velg <em>File</em> -&gt; <em>Add/Remove Snap-in…</em></li>
  <li>Merk <em>Certificates</em> og trykk <em>Add &gt;</em></li>
  <li>Hvis sertifikatet ble installert i <em>Current User</em> velges <em>My user account</em>, hvis det er installert på <em>Local Machine</em> velges <em>Computer Account</em>. Klikk <em>Finish</em> og <em>OK</em></li>
  <li>Ekspander <em>Certificates</em>-noden, velg <em>Personal</em> og åpne <em>Certificates</em></li>
  <li>Dobbeltklikk på sertifikatet du installerte</li>
  <li>Velg <em>Details</em>, scroll ned til <em>Thumbprint</em> og kopier</li>
</ol>

<p><code class="highlighter-rouge">SikkerDigitalPostKlient</code> har støtte for å ta inn <em>thumbprint</em> direkte for <code class="highlighter-rouge">Databehandler</code> og <code class="highlighter-rouge">PostMottaker</code>. Ønsker du å sende inn sertifikater du har allerede har initialisert, kan du kalle konstruktøren som tar inn <code class="highlighter-rouge">X509Certificate2</code>.</p>
</p>
		</div>
	

	
		<h2 id="ytelse">Ytelse</h2>
		<div class="body">
			<p><p>Klientbiblioteket benytter en <code class="highlighter-rouge">HttpWebRequest</code> for å kommunisere med Meldingsformidleren. I en konsollapplikasjon er denne begrenset til maks to samtidige forbindelser om gangen, mens den i en asp.net applikasjon er begrenset til ti. Dersom du ønsker å sende flere brev samtidig kan denne verdien endres f.eks til 3. Mer enn dette anbefales ikke.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">ServicePointManager</span><span class="p">.</span><span class="n">DefaultConnectionLimit</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span></code></pre></figure>

<p>Se <a href="http://msdn.microsoft.com/en-us/library/system.net.servicepointmanager.defaultconnectionlimit(v=vs.110).aspx">ServicePointManager.DefaultConnectionLimit</a> for mer informasjon.</p>
</p>
		</div>
	

	

							</article>
						</section>
						<aside>
							<section class="box">
								<div class="heading hidden-print hidden-xs hidden-sm">
									<h2>Innhold</h2>
								</div>
								<div class="body">
									<nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix-top" id="aside-nav">
									</nav>
								</div>
							</section>
							<!-- List of documentation versions -->
							<div class="list-group col-md-1 list-versions ">
								
									
									<a href="/sikker-digital-post-klient-dotnet/v3/" class="list-group-item "> v3</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v2/" class="list-group-item "> v2</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.6-1.11/" class="list-group-item active"> v1.6-1.11</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.5/" class="list-group-item "> v1.5</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.4/" class="list-group-item "> v1.4</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.3/" class="list-group-item "> v1.3</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.2/" class="list-group-item "> v1.2</a>
								
							</div>
						</aside>
					</div>
				
				<footer>
					<div class="seperator">
						<hr />
					</div>
					<address>
						<ul>
							<li>Kontakt: <a href="mailto:idporten@difi.no">idporten@difi.no</a></li>
							<li>Telefon: +47 95 73 61 03</li>
							<li>E-post: <a href="mailto:postmottak@difi.no">postmottak@difi.no</a></li>
							<li>Org.no: 991 825 827</li>
							<li ><a href="http://www.difi.no/artikkel/2014/12/difis-nettsteder">Difis nettsteder</a></li>
							<li class="last"><a href="http://www.difi.no/artikkel/2014/12/personvernerklaering">Personvern</a></li>
						</ul>
					</address>
				</footer>

				
			  	<script>
				    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
				    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
				    ga('create', 'UA-78356843-1', 'auto', {
				        anonymizeIp: true
				    });
				    ga('send', 'pageview');
				</script>  				
  				

			</div>
			<div role="complementary">
				<a class="scroll-to-top" href="#top">
					<span class="hidden">Go to top of page </span>
					<div class="up-arrow">↑</div>
				</a>
			</div>
			
			<script type="text/javascript" src="//www.difi.no/_style/lib/jquery/jquery-1.11.1.min.js"></script>
			<script type="text/javascript" src="//www.difi.no/_style/lib/bootstrap3/js/bootstrap.js"></script>
			<script type="text/javascript" src="//www.difi.no/themes/contrib/difi3/js/jquery.flexnav.min.js"></script>
			<script type="text/javascript" src="/sikker-digital-post-klient-dotnet/assets/js/docs.min.js"></script>
		</body>
	</html>