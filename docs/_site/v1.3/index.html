<!DOCTYPE html>
<html lang="no">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="shortcut icon" href="//www.difi.no/profiles/difino/themes/difi3_difino/favicon.ico" type="image/vnd.microsoft.icon" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link type="text/css" rel="stylesheet" href="//www.difi.no/_style/site/difino/style.css" media="screen" />
	<link href="/sikker-digital-post-klient-dotnet/assets/css/docs.min.css" rel="stylesheet">
	<link href="/sikker-digital-post-klient-dotnet/assets/css/style.css" rel="stylesheet">
	<link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800%7COpen+Sans+Condensed:300,700%7CSource+Sans+Pro:200,300,regular,600,700,900&amp;subset=latin-ext,vietnamese,latin" media="all" />
	
	<!--[if lt IE 9]>
	<script type="text/javascript" src="//www.difi.no/_style/lib/html5shiv/html5shiv-3.7.2.min.js"></script>
	<script type="text/javascript" src="//www.difi.no/_style/lib/respond/respond-1.4.2.min.js"></script>
	<![endif]-->
	<body class="nodetype-blogg content-article aside-right" >
		<a id="top"/>
			<div id="skip-link">
				<a href="#content">Hopp til hovedinnhold</a>
			</div>
			<div id="page">
				<header>
					<div class="branding sub-portal">
						<div class="logo">
							<a href="/sikker-digital-post-klient-dotnet/"><span>difi.github.io/difi-sikker-digital-post-klient-dotnet</span></a>
						</div>
						<div class="seperator"></div>
						<div class="sub-portal">
							<h1>Sikker Digital Post .NET</h1>
							<p>difi.github.io/difi-sikker-digital-post-klient-dotnet</p>
						</div>
					</div>
					<div class="tools">
						<div class="menu">
							<h2>Sekundærmeny</h2>
							<ul class="links">
								
									<li  class="first" ><a href="/sikker-digital-post-klient-dotnet/about.html">Om sikker digital post</a></li>
								
									<li ><a href="https://github.com/difi/sikker-digital-post-net-klient">GitHub</a></li>
								
									<li  class="last" ><a href="https://github.com/difi/sikker-digital-post-net-klient/issues">Issues</a></li>
								
							</ul>
						</div>
					</div>
					
				</header>
				<div id="above-content">
					<div>
						<section class="box title">
							<div class="heading">
							</div>
							<div class="body">
								<h1>
								<span style="opacity: 1; transition: opacity 500ms; -webkit-transition: opacity 500ms;">
									.NET-bibliotek for sending av sikker digital post for offentlig sektor
								</span>
								</h1>
							</div>
						</section>
						<div class="col-md-9" role="main">
							<!-- Info box notifying that you are using old documentation -->
							
							
						</div>
					</div>
				</div>
				
					<div id="main" class="with-aside">
						<section id="content" tabindex="-1">
							<article class="one-col">
								
									<div class="body">
										<div class="button custom" data-button-type="0" data-url="https://www.nuget.org/packages?q=Difi.SikkerDigitalPost.Klient" role="button" tabindex="0">
											<div class="logo">
												<img alt="logo" src="//www.difi.no/modules/contrib/difi_ckeditor_widgets/plugins/difibutton/icons/difibutton.png">
											</div>
											<div class="text">
												<div class="title">Last ned</div>
												<div class="sub-title">Gå til https://www.nuget.org/packages?q=Difi.SikkerDigitalPost.Klient</div>
											</div>
											<div class="arrow">›</div>
										</div>
									</div>
								
								
	
		<h2 id="hvordankommeigang">Hvordan komme i gang</h2>
		<div class="body">
			<p><p>Klienten er tilgjengelig som en NuGet-pakke. Denne vil oppdateres jevnlig etter hvert som ny funksjonalitet legges til.</p>

<p>For å installere NuGet-pakken, gjør følgende:</p>

<ol>
  <li>Velg <em>TOOLS -&gt; NuGet Package Manager -&gt; Manage Nuget Packages for Solution…</em></li>
  <li>Søk etter <em>sikker-digital-post</em>.
    <ul>
      <li>Ønsker du pre-release, må du sørge for at det står <em>Include Prerelease</em> i drop-down menyen rett over søkeresuløtatene (der det står <em>Stable Only</em>).</li>
    </ul>
  </li>
  <li>Velg <em>sikker-digital-post-klient</em> og trykk <em>Install</em>.</li>
</ol>
</p>
		</div>
	

	
		<h2 id="klientkonfigurasjon">Klientkonfigurasjon</h2>
		<div class="body">
			<p><p>Klientkonfigurasjon brukes for å sette opp koblingsspesifikke innstillinger mot meldingsformidleren, som <code class="highlighter-rouge">ProxyHost</code>, <code class="highlighter-rouge">ProxyScheme</code> og <code class="highlighter-rouge">TimeoutMillisekunder</code>. Denne må sendes med som innparameter til <code class="highlighter-rouge">SikkerDigitalPostKlient</code>.</p>

<p>For å sette url mot meldingsformidler, kan du gjøre dette slik:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">klientkonfigurasjon</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Klientkonfigurasjon</span><span class="p">();</span>

<span class="n">klientkonfigurasjon</span><span class="p">.</span><span class="n">MeldingsformidlerUrl</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"https://eksempelendepunkt.no"</span><span class="p">)</span></code></pre></figure>
</p>
		</div>
	

	
		<h2 id="logging">Logging</h2>
		<div class="body">
			<p><h3 id="customlogger">Logge slik du ønsker</h3>

<p>Behovet for logging er forskjellig fra prosjekt til prosjekt. For å håndtere dette har vi lagt inn mulighet for å sette en egen loggfunksjon på <a href="/#Klientkonfigurasjon">Klientkonfigurasjon</a>. <code class="highlighter-rouge">KlientKonfigurasjon.Logger</code> kan settes til en <code class="highlighter-rouge">Action&lt;TraceEventType, Guid?, String, String&gt;</code>, hvor <code class="highlighter-rouge">TraceEventType</code> er hvilken type loggmelding det er , <code class="highlighter-rouge">Guid</code> er Id på meldingen, nest siste parameter er metoden det ble logget i og til slutt har vi selve meldingen. Her vil meldinger</p>

<p>Her er et eksempel:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">klientkonfigurasjon</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Klientkonfigurasjon</span>
<span class="p">{</span>
    <span class="n">Logger</span> <span class="p">=</span> <span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="n">konversasjonsId</span><span class="p">,</span> <span class="n">metode</span><span class="p">,</span> <span class="n">melding</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"{0} - {1} [{2}]"</span><span class="p">,</span> 
            <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">,</span> 
            <span class="n">melding</span><span class="p">,</span> 
            <span class="n">konversasjonsId</span><span class="p">.</span><span class="nf">GetValueOrDefault</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span></code></pre></figure>

<p>Det som vi logges gjennom denne funksjonen er info om sendingsprosessen og XML som ligger ved i dokumentpakken.</p>

<h3 id="lagrexmltilfil"> Lagre XML som sendes</h3>

<p>Når det sendes brev gjennom Sikker Digital Post, så sendes legges det også ved en del ekstra informasjon. Denne informasjonen er strukturert som XML og er nødvending for at brevet skal leveres til mottaker. Ofte kan dette være svært nyttig informasjon å logge for å se hva som faktisk sendes.</p>

<p>For å aktivere logging av XML så setter du følgende på <code>Klientkonfigurasjon</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Klientkonfigurasjon</span><span class="p">.</span><span class="n">LoggXmlTilFil</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span></code></pre></figure>

<p>Hvis <code> Klientkonfigurasjon.StandardLoggSti </code> ikke settes, så finner du loggfilene i <em>%AppData%/Digipost/Logg</em>.</p>

<h3 id="dokumentpakkelogger">Lagre dokumentpakke som sendes</h3>

<p>Som avsender kan det være ønskelig å lagre selve pakken med dokumenter som sendes. Denne inneholder også XML som sendes og er den faktiske pakken som krypteres og sendes. For å gjøre dette, setter du følgende på <code>Klientkonfigurasjon</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">transportkvittering</span> <span class="p">=</span> <span class="n">sikkerDigitalPostKlient</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">forsendelse</span><span class="p">,</span> <span class="n">lagreDokumentpakke</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span></code></pre></figure>

<p>Hvis <code> Klientkonfigurasjon.StandardLoggSti </code> ikke settes, så finner du dokumentpakkene i <em>%AppData%/Digipost/Dokumentpakke</em>.</p>
</p>
		</div>
	

	
		<h2 id="sendepost">Sende post</h2>
		<div class="body">
			<p><p>For å gjøre det lettere å komme i gang med sending av Sikker digital post så følger det under noen konkrete eksempler.</p>

<blockquote>Det anbefales å bruke dokumentasjon i klassene for mer detaljert beskrivelse av inputparametere.</blockquote>

<h3 id="postinfodigital">PostInfo for digital post</h3>

<p>Først, lag en motaker av type <code class="highlighter-rouge">DigitalPostMottaker</code>:</p>

<blockquote>
Postkassetjenesteleverandørene har ulik behandling av ikke-sensitiv tittel. Se http://begrep.difi.no/Felles/ikkeSensitivTittel for detaljer om denne forskjellen.
</blockquote>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">personnummer</span> <span class="p">=</span> <span class="s">"01013300002"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">postkasseadresse</span> <span class="p">=</span> <span class="s">"ola.nordmann#2233"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">mottakersertifikat</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509Certificate2</span><span class="p">();</span> <span class="c1">//sertifikat hentet fra Oppslagstjenesten
</span><span class="kt">var</span> <span class="n">orgnummerPostkasse</span> <span class="p">=</span> <span class="s">"123456789"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">mottaker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DigitalPostMottaker</span><span class="p">(</span>
	    <span class="n">personnummer</span><span class="p">,</span> 
	    <span class="n">postkasseadresse</span><span class="p">,</span> 
	    <span class="n">mottakersertifikat</span><span class="p">,</span> 
	    <span class="n">orgnummerPostkasse</span>
    <span class="p">);</span>

<span class="kt">var</span> <span class="n">ikkeSensitivTittel</span> <span class="p">=</span> <span class="s">"En tittel som ikke er sensitiv"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">sikkerhetsniv</span><span class="err">å</span> <span class="p">=</span> <span class="n">Sikkerhetsniv</span><span class="err">å</span><span class="p">.</span><span class="n">Niv</span><span class="err">å</span><span class="m">3</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">postInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DigitalPostInfo</span><span class="p">(</span><span class="n">mottaker</span><span class="p">,</span> <span class="n">ikkeSensitivTittel</span><span class="p">,</span> <span class="n">sikkerhetsniv</span><span class="err">å</span><span class="p">);</span></code></pre></figure>

<blockquote>Husk at<code>OrgnummerPostkasse</code> er organisasjonsnummer til leverandør av postkassetjenesten. Organisasjonsnummeret leveres fra oppslagstjenesten sammen med postkasseadressen og sertifikatet til innbygger.</blockquote>

<h3 id="postinfofysisk">PostInfo for fysisk post</h3>

<p>Skal du sende fysisk post må du først lage en <code class="highlighter-rouge">FysiskPostMottaker</code>, en <code class="highlighter-rouge">FysiskPostReturMottaker</code> og sette informasjon om farge og makulering:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">navn</span> <span class="p">=</span> <span class="s">"Ola Nordmann"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">adresse</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NorskAdresse</span><span class="p">(</span><span class="s">"0001"</span><span class="p">,</span> <span class="s">"Oslo"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">mottakersertifikat</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509Certificate2</span><span class="p">();</span> <span class="c1">// sertifikat hentet fra Oppslagstjenesten
</span><span class="kt">var</span> <span class="n">orgnummerPostkasse</span> <span class="p">=</span> <span class="s">"123456789"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">mottaker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FysiskPostMottaker</span><span class="p">(</span><span class="n">navn</span><span class="p">,</span> <span class="n">adresse</span><span class="p">,</span> <span class="n">mottakersertifikat</span><span class="p">,</span> <span class="n">orgnummerPostkasse</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">returMottaker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FysiskPostReturmottaker</span><span class="p">(</span>
    <span class="s">"John Doe"</span><span class="p">,</span> 
    <span class="k">new</span> <span class="nf">NorskAdresse</span><span class="p">(</span><span class="s">"0566"</span><span class="p">,</span> <span class="s">"Oslo"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Adresselinje1</span> <span class="p">=</span> <span class="s">"Returgata 22"</span>
    <span class="p">});</span>

<span class="kt">var</span> <span class="n">postInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FysiskPostInfo</span><span class="p">(</span>
            <span class="n">mottaker</span><span class="p">,</span> 
            <span class="n">Posttype</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> 
            <span class="n">Utskriftsfarge</span><span class="p">.</span><span class="n">SortHvitt</span><span class="p">,</span> 
            <span class="n">Posth</span><span class="err">å</span><span class="n">ndtering</span><span class="p">.</span><span class="n">MakuleringMedMelding</span><span class="p">,</span> 
            <span class="n">returMottaker</span>
        <span class="p">);</span></code></pre></figure>

<p>Her er adressen av type <code class="highlighter-rouge">NorskAdresse</code> eller <code class="highlighter-rouge">UtenlandskAdresse</code>.</p>

<p>Ved sending av fysisk post må man oppgi en returadresse, uavhengig av om brevet er satt til <code class="highlighter-rouge">Posthåndtering.MakuleringMedMelding</code>. Oppretting av en FysiskPostInfo vil da se slik ut:</p>

<h3 id="oppsettfoersending">Oppsett før sending</h3>

<p>Opprett en avsender og en databehandler:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">orgnummerAvsender</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Organisasjonsnummer</span><span class="p">(</span><span class="s">"123456789"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">avsender</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Avsender</span><span class="p">(</span><span class="n">orgnummerAvsender</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">orgnummerDatabehandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Organisasjonsnummer</span><span class="p">(</span><span class="s">"987654321"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">avsendersertifikat</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509Certificate2</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">databehandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Databehandler</span><span class="p">(</span><span class="n">orgnummerDatabehandler</span><span class="p">,</span> <span class="n">avsendersertifikat</span><span class="p">);</span></code></pre></figure>

<p>Hvis man har flere avdelinger innenfor samme organisasjonsnummer, har disse fått unike avsenderidentifikatorer, og kan settes på følgende måte:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">avsender</span><span class="p">.</span><span class="n">Avsenderidentifikator</span> <span class="p">=</span> <span class="s">"Avsenderidentifikator I Organisasjon"</span><span class="p">;</span></code></pre></figure>

<h3 id="oppretteforsendelse">Opprette forsendelse</h3>
<p>Deretterer kan du opprette forsendelse. Forsendelsen inneholder de dokumentene
 som skal til mottakeren:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">hoveddokument</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Dokument</span><span class="p">(</span>
        <span class="n">tittel</span><span class="p">:</span> <span class="s">"Dokumenttittel"</span><span class="p">,</span> 
        <span class="n">dokumentsti</span><span class="p">:</span> <span class="s">"/Dokumenter/Hoveddokument.pdf"</span><span class="p">,</span> 
        <span class="n">mimeType</span><span class="p">:</span> <span class="s">"application/pdf"</span><span class="p">,</span> 
        <span class="n">spr</span><span class="err">å</span><span class="n">kkode</span><span class="p">:</span> <span class="s">"NO"</span><span class="p">,</span> 
        <span class="n">filnavn</span><span class="p">:</span> <span class="s">"filnavn"</span>
    <span class="p">);</span>

<span class="kt">var</span> <span class="n">dokumentpakke</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Dokumentpakke</span><span class="p">(</span><span class="n">hoveddokument</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">vedleggssti</span> <span class="p">=</span> <span class="s">"/Dokumenter/Vedlegg.pdf"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">vedlegg</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Dokument</span><span class="p">(</span>
    <span class="n">tittel</span><span class="p">:</span> <span class="s">"tittel"</span><span class="p">,</span> 
    <span class="n">dokumentsti</span><span class="p">:</span> <span class="n">vedleggssti</span><span class="p">,</span> 
    <span class="n">mimeType</span><span class="p">:</span> <span class="s">"application/pdf"</span><span class="p">,</span> 
    <span class="n">spr</span><span class="err">å</span><span class="n">kkode</span><span class="p">:</span> <span class="s">"NO"</span><span class="p">,</span> 
    <span class="n">filnavn</span><span class="p">:</span> <span class="s">"filnavn"</span><span class="p">);</span>

<span class="n">dokumentpakke</span><span class="p">.</span><span class="nf">LeggTilVedlegg</span><span class="p">(</span><span class="n">vedlegg</span><span class="p">);</span>

<span class="n">Avsender</span> <span class="n">avsender</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span> <span class="c1">//Som initiert tidligere
</span><span class="n">PostInfo</span> <span class="n">postInfo</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span> <span class="c1">//Som initiert tidligere
</span><span class="kt">var</span> <span class="n">forsendelse</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Forsendelse</span><span class="p">(</span><span class="n">avsender</span><span class="p">,</span> <span class="n">postInfo</span><span class="p">,</span> <span class="n">dokumentpakke</span><span class="p">);</span></code></pre></figure>

<h3 id="opprettKlient">Opprette klient og sende post </h3>
<p>Siste steg er å opprette en <code class="highlighter-rouge">SikkerDigitalPostKlient</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">klientKonfig</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Klientkonfigurasjon</span><span class="p">(</span><span class="n">Milj</span><span class="err">ø</span><span class="p">.</span><span class="n">FunksjoneltTestmilj</span><span class="err">ø</span><span class="p">);</span>

<span class="n">Databehandler</span> <span class="n">databehandler</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span> <span class="c1">//Som initiert tidligere
</span><span class="n">Forsendelse</span> <span class="n">forsendelse</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>     <span class="c1">//Som initiert tidligere
</span>
<span class="kt">var</span> <span class="n">sdpKlient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SikkerDigitalPostKlient</span><span class="p">(</span><span class="n">databehandler</span><span class="p">,</span> <span class="n">klientKonfig</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">transportkvittering</span> <span class="p">=</span> <span class="n">sdpKlient</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">forsendelse</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">transportkvittering</span> <span class="k">is</span> <span class="n">TransportOkKvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//Når alt går fint	
</span><span class="p">}</span>
<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">transportkvittering</span> <span class="k">is</span> <span class="n">TransportFeiletKvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">beskrivelse</span> <span class="p">=</span> <span class="p">((</span><span class="n">TransportFeiletKvittering</span><span class="p">)</span><span class="n">transportkvittering</span><span class="p">).</span><span class="n">Beskrivelse</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Transportkvitteringen får du tilbake umiddelbart; den trenger du ikke å polle for å få.</p>

<h3 id="henteKvitteringer"> Hente kvitteringer</h3>
<p>For å hente kvitteringer må du sende en kvitteringsforespørsel:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">k</span><span class="err">ø</span><span class="n">Id</span> <span class="p">=</span> <span class="s">"MpcId"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">kvitteringsForesp</span><span class="err">ø</span><span class="n">rsel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Kvitteringsforesp</span><span class="err">ø</span><span class="nf">rsel</span><span class="p">(</span><span class="n">Prioritet</span><span class="p">.</span><span class="n">Prioritert</span><span class="p">,</span> <span class="n">k</span><span class="err">ø</span><span class="n">Id</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">" &gt; Henter kvittering på kø '{0}'..."</span><span class="p">,</span> <span class="n">kvitteringsForesp</span><span class="err">ø</span><span class="n">rsel</span><span class="p">.</span><span class="n">Mpc</span><span class="p">);</span>

<span class="n">Kvittering</span> <span class="n">kvittering</span> <span class="p">=</span> <span class="n">sdpKlient</span><span class="p">.</span><span class="nf">HentKvittering</span><span class="p">(</span><span class="n">kvitteringsForesp</span><span class="err">ø</span><span class="n">rsel</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - Kø '{0}' er tom. Stopper å hente meldinger. "</span><span class="p">,</span> <span class="n">kvitteringsForesp</span><span class="err">ø</span><span class="n">rsel</span><span class="p">.</span><span class="n">Mpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">TransportFeiletKvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">feil</span> <span class="p">=</span> <span class="p">((</span><span class="n">TransportFeiletKvittering</span><span class="p">)</span> <span class="n">kvittering</span><span class="p">).</span><span class="n">Beskrivelse</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"En feil skjedde under transport."</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">Leveringskvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - En leveringskvittering ble hentet!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="err">Å</span><span class="n">pningskvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - Har du sett. Noen har åpnet et brev. Moro."</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">Returpostkvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - Du har fått en returpostkvittering for fysisk post."</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">Mottakskvittering</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - Kvittering på sending av fysisk post mottatt."</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kvittering</span> <span class="k">is</span> <span class="n">Feilmelding</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">feil</span> <span class="p">=</span> <span class="p">(</span><span class="n">Feilmelding</span><span class="p">)</span><span class="n">kvittering</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"  - En feilmelding ble hentet :"</span> <span class="p">+</span> <span class="n">feil</span><span class="p">.</span><span class="n">Detaljer</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<blockquote>
Husk at det ikke er mulig å hente nye kvitteringer før du har bekreftet mottak av nåværende. 
</blockquote>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">sdpKlient</span><span class="p">.</span><span class="nf">Bekreft</span><span class="p">((</span><span class="n">Forretningskvittering</span><span class="p">)</span><span class="n">kvittering</span><span class="p">);</span></code></pre></figure>

<p>Kvitteringer du mottar når du gjør en kvitteringsforespørsel kan være av følgende typer: <code class="highlighter-rouge">Leveringskvittering</code>,<code class="highlighter-rouge">Åpningskvittering</code>, <code class="highlighter-rouge">Returpostkvittering</code>, <code class="highlighter-rouge">Mottakskvittering</code> eller <code class="highlighter-rouge">Feilmelding</code>. Kvittering kan også være av typen<code class="highlighter-rouge">TransportFeiletKvittering</code>. Dette kan skje når selve kvitteringsforespørselen er feilformatert.</p>

<blockquote>
Husk at hvis kvitteringen er <code>null</code> så er køen tom. Du henter bare kvitteringer fra kø gitt av <code>MpcId</code> og <code>Prioritet</code> på Dokumentpakken som ble sendt. Hvis ikke dette ble satt spesifikt vil <code>MpcId = ""</code> og <code>Prioritet = Prioritet.Normal</code>.
</blockquote>
</p>
		</div>
	

	
		<h2 id="installeresertifikater">Installere sertifikater</h2>
		<div class="body">
			<p><p>For å sende sikker digital post trenger du å installere sertifikater. Grunnen til at vi ønsker å installere de er først og fremst sikkerhet. Alle sertifikater har en unik identifikator som kalles thumbprint. Hvis du ikke ønsker å håndtere selv i koden hvordan sertifikatene skal lastes, så kan du følge guiden under, steg for steg. Til slutt gjennomgås det hvordan du kan finne thumbprint til de installerte sertifikatene.</p>

<h3 id="databehandlersertifikat">Legg inn databehandlersertifikat i certificate store</h3>

<blockquote> Databehandlersertifikat er det sertifikatet du har fått utstedt for å kunne sende post.  </blockquote>

<ol>
  <li>Dobbeltklikk på sertifikatet (Sertifikatnavn.p12)</li>
  <li>Velg at sertifikatet skal lagres i <em>Current User</em> og trykk <em>Next</em></li>
  <li>Filnavn skal nå være utfylt. Trykk <em>Next</em></li>
  <li>Skriv inn passord for privatekey og velg <em>Mark this key as exportable …</em>, trykk <em>Next</em></li>
  <li>Velg <em>Automatically select the certificate store based on the type of certificate</em></li>
  <li><em>Next</em> og <em>Finish</em></li>
  <li>Får du spørsmål om å godta sertifikatet så gjør det.</li>
  <li>Du skal da få en dialog som sier at importeringen var vellykket. Trykk <em>Ok</em>.</li>
</ol>

<h3 id="finneinstallertsertifikat">Finne installert sertifikat</h3>

<p>For å finne databehandlersertifikat i kode så må du finne <em>thumbprint</em>. Dette gjøres lettest gjennom <em>Microsoft Management Console</em> (mmc.exe).</p>

<p><code>SikkerDigitalPostKlient</code> har støtte for å ta in <em>thumbprint</em> direkte for <code>Databehandler</code> og <code>PostMottaker</code>.
Ønsker du å sende inn sertifikater du har allerede har initialisert, kan du kalle konstruktøren som tar inn <code> X509Certificate2</code>.</p>

<p>Som bruker av dette biblioteket er du en Databehandler som har ansvar for sending av meldinger. For å gjøre dette trenger du et sertifikat for å kunne autentisere deg mot Meldingsformidleren. Du kan lese mer om aktørene <a href="http://begrep.difi.no/SikkerDigitalPost/forretningslag/Aktorer">her</a>.</p>
</p>
		</div>
	

	
		<h2 id="ytelse">Ytelse</h2>
		<div class="body">
			<p><p>Klientbiblioteket benytter en <code class="highlighter-rouge">HttpWebRequest</code> for å kommunisere med Meldingsformidleren. I en konsollapplikasjon er denne begrenset til maks to samtidige forbindelser om gangen, mens den i en asp.net applikasjon er begrenset til ti. Dersom du ønsker å sende flere brev samtidig kan denne verdien endres f.eks til 3. Mer enn dette anbefales ikke.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">ServicePointManager</span><span class="p">.</span><span class="n">DefaultConnectionLimit</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span></code></pre></figure>

<p>Se <a href="http://msdn.microsoft.com/en-us/library/system.net.servicepointmanager.defaultconnectionlimit(v=vs.110).aspx">ServicePointManager.DefaultConnectionLimit</a> for mer informasjon.</p>
</p>
		</div>
	

	

							</article>
						</section>
						<aside>
							<section class="box">
								<div class="heading hidden-print hidden-xs hidden-sm">
									<h2>Innhold</h2>
								</div>
								<div class="body">
									<nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix-top" id="aside-nav">
									</nav>
								</div>
							</section>
							<!-- List of documentation versions -->
							<div class="list-group col-md-1 list-versions ">
								
									
									<a href="/sikker-digital-post-klient-dotnet/v3/" class="list-group-item active"> v3</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v2/" class="list-group-item "> v2</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.6-1.11/" class="list-group-item "> v1.6-1.11</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.5/" class="list-group-item "> v1.5</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.4/" class="list-group-item "> v1.4</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.3/" class="list-group-item active"> v1.3</a>
								
									
									<a href="/sikker-digital-post-klient-dotnet/v1.2/" class="list-group-item "> v1.2</a>
								
							</div>
						</aside>
					</div>
				
				<footer>
					<div class="seperator">
						<hr />
					</div>
					<address>
						<ul>
							<li>Kontakt: <a href="mailto:idporten@difi.no">idporten@difi.no</a></li>
							<li>Telefon: +47 95 73 61 03</li>
							<li>E-post: <a href="mailto:postmottak@difi.no">postmottak@difi.no</a></li>
							<li>Org.no: 991 825 827</li>
							<li ><a href="http://www.difi.no/artikkel/2014/12/difis-nettsteder">Difis nettsteder</a></li>
							<li class="last"><a href="http://www.difi.no/artikkel/2014/12/personvernerklaering">Personvern</a></li>
						</ul>
					</address>
				</footer>

				
			  	<script>
				    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
				    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
				    ga('create', 'UA-78356843-1', 'auto', {
				        anonymizeIp: true
				    });
				    ga('send', 'pageview');
				</script>  				
  				

			</div>
			<div role="complementary">
				<a class="scroll-to-top" href="#top">
					<span class="hidden">Go to top of page </span>
					<div class="up-arrow">↑</div>
				</a>
			</div>
			
			<script type="text/javascript" src="//www.difi.no/_style/lib/jquery/jquery-1.11.1.min.js"></script>
			<script type="text/javascript" src="//www.difi.no/_style/lib/bootstrap3/js/bootstrap.js"></script>
			<script type="text/javascript" src="//www.difi.no/themes/contrib/difi3/js/jquery.flexnav.min.js"></script>
			<script type="text/javascript" src="/sikker-digital-post-klient-dotnet/assets/js/docs.min.js"></script>
		</body>
	</html>